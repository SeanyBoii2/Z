--// Yellow Dot Above Every Player (No Lag, No Wall-Through)
-- Place in StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local MAX_DISTANCE = 350
local DOT_SIZE = UDim2.new(0, 10, 0, 10)
local DOT_COLOR = Color3.fromRGB(255, 255, 0)

-- Store dots
local dots = {}

-- Create a dot UI for a given player
local function createDotForPlayer(player)
	if player == LocalPlayer then return end

	local Billboard = Instance.new("BillboardGui")
	Billboard.Name = "YellowDot"
	Billboard.AlwaysOnTop = false
	Billboard.Size = UDim2.new(0, 0, 0, 0)
	Billboard.StudsOffset = Vector3.new(0, 3, 0)
	Billboard.MaxDistance = MAX_DISTANCE

	local Dot = Instance.new("Frame")
	Dot.Size = DOT_SIZE
	Dot.BackgroundColor3 = DOT_COLOR
	Dot.BorderSizePixel = 0
	Dot.AnchorPoint = Vector2.new(0.5, 0.5)
	Dot.Position = UDim2.new(0.5, 0, 0.5, 0)
	Dot.BackgroundTransparency = 1
	Dot.Parent = Billboard

	dots[player] = { Billboard = Billboard, Dot = Dot }

	player.CharacterAdded:Connect(function(char)
		local head = char:WaitForChild("Head", 5)
		if head then
			Billboard.Adornee = head
			Dot.BackgroundTransparency = 0
		end
	end)

	player.CharacterRemoving:Connect(function()
		Dot.BackgroundTransparency = 1
	end)

	-- If already spawned
	if player.Character and player.Character:FindFirstChild("Head") then
		Billboard.Adornee = player.Character.Head
		Dot.BackgroundTransparency = 0
	end

	Billboard.Parent = workspace.CurrentCamera
end

-- Remove dot when player leaves
local function removeDot(player)
	if dots[player] then
		dots[player].Billboard:Destroy()
		dots[player] = nil
	end
end

-- Visibility + range update loop
RunService.RenderStepped:Connect(function()
	for player, data in pairs(dots) do
		local Billboard = data.Billboard
		local Dot = data.Dot
		local char = player.Character
		local head = char and char:FindFirstChild("Head")

		if head and Billboard.Adornee == head then
			local dist = (Camera.CFrame.Position - head.Position).Magnitude
			if dist <= MAX_DISTANCE then
				-- Raycast for wall blocking
				local rayParams = RaycastParams.new()
				rayParams.FilterDescendantsInstances = {LocalPlayer.Character}
				rayParams.FilterType = Enum.RaycastFilterType.Exclude

				local result = workspace:Raycast(Camera.CFrame.Position, (head.Position - Camera.CFrame.Position), rayParams)
				if result and result.Instance and not head:IsDescendantOf(result.Instance) then
					Dot.Visible = false -- behind wall
				else
					Dot.Visible = true
				end
			else
				Dot.Visible = false
			end
		else
			Dot.Visible = false
		end
	end
end)

-- Add for existing players
for _, player in ipairs(Players:GetPlayers()) do
	createDotForPlayer(player)
end

-- Manage new/left players
Players.PlayerAdded:Connect(createDotForPlayer)
Players.PlayerRemoving:Connect(removeDot)
