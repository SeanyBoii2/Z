local Players = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

-- CONFIG
local TAG_NAME = "HitboxProcessed"
local PART_NAMES = {"Head", "UpperTorso"} -- alternate between these
local HITBOX_SIZE = Vector3.new(8, 8, 8)
local TARGET_FOLDER_NAME = "Mobs"
local HITBOX_TRANSPARENCY = 0.9
local HIGHLIGHT_COLOR = Color3.fromRGB(255, 0, 0)

-- TOGGLES
local highlightEnabled = false
local playersEnabled = true

-- Local player
local localPlayer = Players.LocalPlayer

-- Alternation tracker
local currentIndex = 1
local function getNextPartName()
	currentIndex += 1
	if currentIndex > #PART_NAMES then
		currentIndex = 1
	end
	return PART_NAMES[currentIndex]
end

-- Helpers
local function isPlayerCharacter(model)
	return model and model:IsA("Model") and Players:GetPlayerFromCharacter(model) ~= nil
end

local function isLocalPlayerCharacter(model)
	return localPlayer and localPlayer.Character and model == localPlayer.Character
end

local function removeDecals(part)
	for _, decal in ipairs(part:GetChildren()) do
		if decal:IsA("Decal") or decal:IsA("Texture") then
			decal:Destroy()
		end
	end
end

local function makeModelNonCollidable(model)
	for _, part in ipairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			part.CanCollide = false
		end
	end
end

local function addHighlight(model)
	if not highlightEnabled then return end
	for _, torsoName in ipairs({"UpperTorso", "Torso"}) do
		local torso = model:FindFirstChild(torsoName)
		if torso and torso:IsA("BasePart") then
			if not torso:FindFirstChild("HitboxHighlight") then
				local highlight = Instance.new("Highlight")
				highlight.Name = "HitboxHighlight"
				highlight.Adornee = torso
				highlight.FillColor = HIGHLIGHT_COLOR
				highlight.OutlineTransparency = 1
				highlight.Parent = torso
			end
		end
	end
end

-- Refresh hitbox safely
local function refreshHitbox(part)
	if not part or not part.Parent then return end

	if part.Size ~= HITBOX_SIZE then
		part.Size = HITBOX_SIZE
	end
	if not part.Massless then
		part.Massless = true
	end
	if part.CanCollide then
		part.CanCollide = false
	end
	if part.Transparency ~= HITBOX_TRANSPARENCY then
		part.Transparency = HITBOX_TRANSPARENCY
	end

	removeDecals(part)

	local mesh = part:FindFirstChildOfClass("SpecialMesh") or part:FindFirstChildOfClass("Mesh")
	if mesh then
		local desiredScale = HITBOX_SIZE / part.Size
		if mesh.Scale ~= desiredScale then
			mesh.Scale = desiredScale
		end
	end
end

-- Main
local function applyHitbox(part)
	local model = part.Parent
	if not model or not part:IsA("BasePart") then return end
	if isLocalPlayerCharacter(model) then return end
	if not playersEnabled and isPlayerCharacter(model) then return end
	if CollectionService:HasTag(part, TAG_NAME) then return end

	CollectionService:AddTag(part, TAG_NAME)

	makeModelNonCollidable(model)
	refreshHitbox(part)
	addHighlight(model)

	part:GetPropertyChangedSignal("Size"):Connect(function()
		refreshHitbox(part)
	end)
	part:GetPropertyChangedSignal("Transparency"):Connect(function()
		refreshHitbox(part)
	end)
	part:GetPropertyChangedSignal("CanCollide"):Connect(function()
		refreshHitbox(part)
	end)

	local humanoid = model:FindFirstChildOfClass("Humanoid")
	if humanoid then
		humanoid.Died:Once(function()
			if model and model.Parent then
				model:Destroy()
			end
		end)
	end
end

-- Scan existing
local function scanTarget()
	local partName = getNextPartName()
	local target = Workspace:FindFirstChild(TARGET_FOLDER_NAME) or Workspace

	if target then
		for _, part in ipairs(target:GetDescendants()) do
			if part:IsA("BasePart") and part.Name == partName then
				applyHitbox(part)
			end
		end
	end

	if playersEnabled then
		for _, plr in ipairs(Players:GetPlayers()) do
			if plr ~= localPlayer and plr.Character then
				local body = plr.Character:FindFirstChild(partName)
				if body and body:IsA("BasePart") then
					applyHitbox(body)
				end
			end
		end
	end
end

scanTarget()

-- Dynamic new parts
Workspace.DescendantAdded:Connect(function(descendant)
	if descendant:IsA("BasePart") and descendant.Name == PART_NAMES[currentIndex] then
		local target = Workspace:FindFirstChild(TARGET_FOLDER_NAME) or Workspace
		if (target and descendant:IsDescendantOf(target)) or playersEnabled then
			if not isLocalPlayerCharacter(descendant.Parent) then
				applyHitbox(descendant)
			end
		end
	end
end)
