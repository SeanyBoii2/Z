--[[
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║               SPOOKALICIOUS V4 — DEVELOPER TEMPLATE                          ║
║                         (UPDATED WITH WORKING AUTO-RELOAD)                   ║
║                                                                              ║
║   This template shows you how to build a full hub using the                  ║
║   Spookalicious V4 API. It comes pre-loaded with:                            ║
║                                                                              ║
║     • Config page   — Save/load settings across sessions                     ║
║     • Server page   — Server tools, rejoin, server hop, reset                ║
║     • Misc page     — Utilities and info                                     ║
║     • Settings      — Built into the API (theme, sounds, particles)          ║
║                                                                              ║
║   Just add your own pages using the examples below!                          ║
║                                                                              ║
║   CONTROLS:                                                                  ║
║     PC:     LEFT ALT = open/close, Arrow keys = navigate                     ║
║             F/Enter = select, X = back, V = mouse mode                       ║
║     Mobile: Skull button = open, swipe = navigate, tap = select              ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
--]]


--══════════════════════════════════════════════════════════════
--  STEP 1: AUTO-RELOAD SETUP (IMPORTANT - DO THIS FIRST!)
--══════════════════════════════════════════════════════════════
--  ⚠️ CHANGE THE URL BELOW TO YOUR SCRIPT'S GITHUB RAW URL ⚠️
--  This enables auto-reload when rejoining or server hopping

local SCRIPT_URL = "YOUR_SCRIPT_URL_HERE"  -- ← CHANGE THIS!

-- Setup queue function (works with Solara and other executors)
local queueteleport = queue_on_teleport or (syn and syn.queue_on_teleport) or (fluxus and fluxus.queue_on_teleport)

if queueteleport then
    print("[AUTO-RELOAD] Queue function found and ready")
else
    warn("[AUTO-RELOAD] No queue function available - auto-reload disabled")
end


--══════════════════════════════════════════════════════════════
--  STEP 2: LOAD THE LIBRARY
--══════════════════════════════════════════════════════════════

local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/SeanyBoii2/Z/refs/heads/main/SPOOKALICIOUS%20V4%20API/SpookaliciousV4.lua"))()


--══════════════════════════════════════════════════════════════
--  STEP 3: CREATE THE WINDOW
--══════════════════════════════════════════════════════════════

local Window = Library:CreateWindow("MY HUB", "V1.0")  -- ← change title and version


--══════════════════════════════════════════════════════════════
--  STEP 4: SERVICES
--══════════════════════════════════════════════════════════════

local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local _hasFS = (typeof(writefile) == "function" and typeof(readfile) == "function")

local function sendNotification(title, text)
    for i = 1, 10 do
        local success = pcall(function()
            StarterGui:SetCore("SendNotification", {
                Title = title,
                Text = text,
                Duration = 5,
            })
        end)
        if success then break end
        task.wait(0.5)
    end
end

-- Track toggles that should reset to OFF/default when config loads
local functionalToggles = {}

local function registerFunctionalToggle(toggle, defaultState)
    table.insert(functionalToggles, { ref = toggle, default = defaultState or false })
end

local function resetFunctionalToggles()
    for _, item in ipairs(functionalToggles) do
        item.ref:Set(item.default)
    end
end


-- ┌────────────────────────────────────────────────────────────┐
-- │  ADD YOUR PAGES BELOW THIS LINE                            │
-- └────────────────────────────────────────────────────────────┘




-- ┌────────────────────────────────────────────────────────────┐
-- │  ADD YOUR PAGES ABOVE THIS LINE                            │
-- └────────────────────────────────────────────────────────────┘


--╔══════════════════════════════════════════════════════════════════════════╗
--║                   SERVER PAGE (do not modify)                          ║
--╚══════════════════════════════════════════════════════════════════════════╝

local ServerPage = Window:CreatePage("Server")
local ServerSection = ServerPage:CreateSection("Server Tools")

ServerSection:CreateTextbox("Chat Message", "Type message...", function(text)
    if text and #text > 0 then
        Window:Notify("Message: " .. text)
    end
end)

ServerSection:CreateButton("Copy Server ID", function()
    if setclipboard then
        setclipboard(game.JobId)
        Window:Notify("Server ID copied!")
    else
        Window:Notify("Clipboard not supported")
    end
end)

ServerSection:CreateButton("Rejoin Server", function()
    Window:Notify("Rejoining...")
    
    -- Queue script before teleporting (Infinite Yield style - most reliable)
    if queueteleport and SCRIPT_URL ~= "YOUR_SCRIPT_URL_HERE" then
        local queueCode = 'loadstring(game:HttpGet("' .. SCRIPT_URL .. '"))()'
        pcall(function()
            queueteleport(queueCode)
        end)
        print("[REJOIN] Script queued successfully")
    end
    
    -- Small delay then teleport
    task.wait(0.3)
    pcall(function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId)
    end)
end)

ServerSection:CreateButton("Server Hop", function()
    Window:Notify("Finding new server...")
    
    -- Queue script before hopping
    if queueteleport and SCRIPT_URL ~= "YOUR_SCRIPT_URL_HERE" then
        local queueCode = 'loadstring(game:HttpGet("' .. SCRIPT_URL .. '"))()'
        pcall(function()
            queueteleport(queueCode)
        end)
        print("[SERVER HOP] Script queued")
    end
    
    -- Get list of servers and join a different one
    local success, result = pcall(function()
        local servers = HttpService:JSONDecode(
            game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")
        )
        
        if servers and servers.data then
            for _, server in pairs(servers.data) do
                if server.id ~= game.JobId and server.playing < server.maxPlayers then
                    Window:Notify("Joining new server...")
                    task.wait(0.5)
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                    return
                end
            end
            Window:Notify("No other servers available")
        else
            Window:Notify("Could not fetch servers")
        end
    end)
    
    if not success then
        warn("[SERVER HOP] Error:", result)
        Window:Notify("Server hop failed!")
    end
end)

ServerSection:CreateButton("Reset Character", function()
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.Health = 0
    end
    Window:Notify("Character reset!")
end)

ServerSection:CreateDivider()

-- ═══════════════════════════════════════════════════════════
--  SERVER SAVER SYSTEM
-- ═══════════════════════════════════════════════════════════
local FILE_NAME = "SavedServers_MyHub.json"  -- ← Change this name for your hub

-- Save/Load System
local function saveServerData(data)
    if writefile then
        writefile(FILE_NAME, HttpService:JSONEncode(data))
    end
end

local function loadServerData()
    if isfile and isfile(FILE_NAME) then
        local success, result = pcall(function()
            return HttpService:JSONDecode(readfile(FILE_NAME))
        end)
        if success then return result end
    end
    return {}
end

-- Server Map (maps display name to index)
local serverMap = {}
local selectedServer = nil

local function buildServerList()
    local data = loadServerData()
    local names = {}
    serverMap = {}

    for i, v in ipairs(data) do
        local displayName = "#" .. i .. " | " .. v.Time
        table.insert(names, displayName)
        serverMap[displayName] = i
    end

    return data, names
end

-- Build initial list
local serverData, initialServerNames = buildServerList()

-- Create Dropdown FIRST (so buttons can reference it)
local savedServerDropdown = ServerSection:CreateDropdown("Saved Servers", {
    List = initialServerNames,
    Default = initialServerNames[1] or "None"
}, function(value)
    selectedServer = value
end)

selectedServer = initialServerNames[1]

-- Save Current Server Button
ServerSection:CreateButton("Save Current Server", function()
    local data = loadServerData()
    local entry = {
        JobId = game.JobId,
        PlaceId = game.PlaceId,
        Time = os.date("%H:%M | %d %b")
    }
    table.insert(data, 1, entry)
    if #data > 20 then table.remove(data, 21) end  -- Keep max 20
    saveServerData(data)

    local _, names = buildServerList()
    savedServerDropdown:Refresh(names)
    selectedServer = names[1]

    Window:Notify("Server Saved!")
end)

-- Join Saved Server Button
ServerSection:CreateButton("Join Saved Server", function()
    if not selectedServer or selectedServer == "None" then
        Window:Notify("No server selected!")
        return
    end

    local index = serverMap[selectedServer]
    if not index then
        Window:Notify("Server not found! Try refreshing.")
        return
    end

    local data = loadServerData()
    local server = data[index]

    if not server then
        Window:Notify("Server data missing!")
        return
    end

    -- Queue script before teleporting
    if queueteleport and SCRIPT_URL ~= "YOUR_SCRIPT_URL_HERE" then
        local queueCode = 'loadstring(game:HttpGet("' .. SCRIPT_URL .. '"))()'
        pcall(function()
            queueteleport(queueCode)
        end)
    end

    Window:Notify("Joining: " .. server.Time)
    task.wait(0.3)
    TeleportService:TeleportToPlaceInstance(server.PlaceId, server.JobId, player)
end)

-- Refresh Server List Button
ServerSection:CreateButton("Refresh Server List", function()
    local data, names = buildServerList()
    savedServerDropdown:Refresh(names)
    if #names > 0 then
        selectedServer = names[1]
    end
    Window:Notify("Found " .. #data .. " saved servers")
end)

-- Clear Server History Button
ServerSection:CreateButton("Clear Server History", function()
    saveServerData({})
    serverMap = {}
    selectedServer = nil
    savedServerDropdown:Refresh({})
    Window:Notify("Server history cleared!")
end)


--╔══════════════════════════════════════════════════════════════════════════╗
--║                   MISC PAGE (do not modify)                            ║
--╚══════════════════════════════════════════════════════════════════════════╝

local MiscPage = Window:CreatePage("Misc")

-- ═══ Utilities ═══
local UtilSection = MiscPage:CreateSection("Utilities")

local antiAfkToggle = UtilSection:CreateToggle("Anti-AFK", {
    Toggled = true
}, function(value)
    Window:Notify("Anti-AFK: " .. (value and "ON" or "OFF"))
end)
registerFunctionalToggle(antiAfkToggle, true)

player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

UtilSection:CreateButton("Copy Discord", function()
    if setclipboard then
        setclipboard("spookyie")
        Window:Notify("Discord copied: spookyie")
    else
        Window:Notify("Discord: spookyie")
    end
end)

UtilSection:CreateTextbox("Webhook URL", "Paste webhook...", function(url)
    Window:Notify("Webhook saved!")
end)

UtilSection:CreateDivider()

-- ═══ Information ═══
local InfoSection = MiscPage:CreateSection("Information")

InfoSection:CreateLabel("Script: MY HUB V1.0")              -- ← change script name only
InfoSection:CreateLabel("Discord: spookyie")
InfoSection:CreateDivider()

InfoSection:CreateButton("Credits", function()
    Window:Notify("Made by Spooky // Discord: spookyie")
end)

InfoSection:CreateButton("Destroy GUI", function()
    pcall(function() Window:SaveConfig("Default") end)
    Window:Notify("Goodbye!")
    task.wait(1)
    Window:Destroy()
end)


--╔══════════════════════════════════════════════════════════════════════════╗
--║                  CONFIG PAGE (do not modify)                           ║
--╚══════════════════════════════════════════════════════════════════════════╝

local ConfigPage = Window:CreatePage("Config")
local ConfigSection = ConfigPage:CreateSection("Save & Load")

ConfigSection:CreateLabel("Save your settings to persist across sessions")
ConfigSection:CreateDivider()

local currentProfile = "Default"

ConfigSection:CreateTextbox("Profile Name", "Default", function(text)
    if text and #text > 0 then
        currentProfile = text
    end
end)

ConfigSection:CreateDivider()

ConfigSection:CreateButton("Save Config", function()
    local ok = Window:SaveConfig(currentProfile)
    Window:Notify(ok and ("Saved: " .. currentProfile) or "Save failed!")
end)

ConfigSection:CreateButton("Load Config", function()
    local ok = Window:LoadConfig(currentProfile)
    if ok then
        task.wait(0.1)
        resetFunctionalToggles()
        Window:Notify("Loaded: " .. currentProfile)
    else
        Window:Notify("No config found: " .. currentProfile)
    end
end)

ConfigSection:CreateButton("Delete Config", function()
    Window:DeleteConfig(currentProfile)
    Window:Notify("Deleted: " .. currentProfile)
end)

ConfigSection:CreateDivider()

ConfigSection:CreateButton("List Profiles", function()
    local profiles = Window:GetProfiles()
    if #profiles > 0 then
        Window:Notify(table.concat(profiles, ", "))
    else
        Window:Notify("No saved profiles")
    end
end)

ConfigSection:CreateButton("Export to Clipboard", function()
    local ok = Window:ExportConfig(currentProfile)
    Window:Notify(ok and "Copied to clipboard!" or "Export failed")
end)

ConfigSection:CreateDivider()
ConfigSection:CreateLabel(_hasFS and "Saves to: SpookyHub_Configs/" or "No file system — session only!")


--══════════════════════════════════════════════════════════════
--  INITIALIZATION
--══════════════════════════════════════════════════════════════

task.wait(0.5)

local loaded = Window:LoadConfig("Default")
if loaded then
    print("[HUB] Config loaded!")
else
    print("[HUB] No saved config — saving defaults")
    Window:SaveConfig("Default")
end

resetFunctionalToggles()

game:BindToClose(function()
    pcall(function() Window:SaveConfig("Default") end)
end)

print("[HUB] Ready!")
