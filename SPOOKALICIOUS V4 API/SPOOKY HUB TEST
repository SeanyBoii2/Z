--[[
    ================================================================
    =              SPOOKY HUB V4 — WITH FIXED ADDONS               =
    =              Full features with Config & New Elements         =
    ================================================================
--]]

--================================--
--       WHITELIST SYSTEM         --
--================================--
local WHITELISTED_USERS = {
    "ULTIMATEGODLUFFY",
    "ModeratorJuli2",
}

--================================--
--          SERVICES              --
--================================--
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")

local player = Players.LocalPlayer

--================================--
--        NOTIFICATION            --
--================================--
local function sendNotification(title, text)
    for i = 1, 10 do
        local success = pcall(function()
            StarterGui:SetCore("SendNotification", {
                Title = title,
                Text = text,
                Duration = 5,
            })
        end)
        if success then break end
        task.wait(0.5)
    end
end

--================================--
--       WHITELIST CHECK          --
--================================--
print("Player Name: " .. player.Name)

local isWhitelisted = false
for _, name in ipairs(WHITELISTED_USERS) do
    if string.lower(player.Name) == string.lower(name) then
        isWhitelisted = true
        break
    end
end

if not isWhitelisted then
    sendNotification("ACCESS DENIED", "You are not whitelisted. Discord: spookyie")
    print("ACCESS DENIED - Username not in whitelist: " .. player.Name)
    return
end

sendNotification("WELCOME", "Welcome " .. player.Name .. "!")

-- Silent loads
pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/SeanyBoii2/Z/refs/heads/main/CREDITS"))() end)
pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/SeanyBoii2/Z/refs/heads/main/CONTROL%20PLAYER"))() end)

--================================--
--         LOAD LIBRARY           --
--================================--
print("[SPOOKY HUB] Loading Spookalicious V4 library...")

-- Load base library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/SeanyBoii2/Z/refs/heads/main/SPOOKALICIOUS%20V4%20API/SpookaliciousV4.lua"))()

print("[SPOOKY HUB] Loading addons...")

-- Load the FIXED addons (use these URLs after uploading the fixed versions)
local ConfigSystem = loadstring(game:HttpGet("https://raw.githubusercontent.com/SeanyBoii2/Z/refs/heads/main/SPOOKALICIOUS%20V4%20API/ConfigSystem_Addon.lua"))()
local NewElements = loadstring(game:HttpGet("https://raw.githubusercontent.com/SeanyBoii2/Z/refs/heads/main/SPOOKALICIOUS%20V4%20API/NewElements_Addon.lua"))()

print("[SPOOKY HUB] Addons loaded!")

--================================--
--   EXTEND & CREATE WINDOW       --
--================================--

-- Extend library BEFORE creating window
NewElements.Extend(Library)

-- Create window
local Window = Library:CreateWindow("SPOOKY HUB", "V4")

-- Attach config system AFTER creating window
ConfigSystem:Attach(Window)
Window:SetAutoSave(false) -- Don't auto-save, we'll save manually

--================================--
--      GLOBAL VARIABLES          --
--================================--
local loadedScripts = {}

-- Movement variables
local speedEnabled = false
local flyEnabled = false
local noclipEnabled = false
local infJumpEnabled = false
local flySpeed = 80
local flyBodyVel = nil
local flyBodyGyro = nil


--╔══════════════════════════════════════════════════════════════════════════╗
--║                          SCRIPTS PAGE                                    ║
--╚══════════════════════════════════════════════════════════════════════════╝

local SCRIPTS = {
	{
		Name = "Motorcycle Tricks",
		URL = "https://raw.githubusercontent.com/SeanyBoii2/Universal-Scripts/refs/heads/main/Motorcycle%20Tricks%20Universal.txt",
	},
	{
		Name = "Superman Fly",
		URL = "https://raw.githubusercontent.com/SeanyBoii2/Universal-Scripts/refs/heads/main/Superman%20Fly/Fly%20Gui",
	},
	{
		Name = "NPC Autofarm",
		URL = "https://raw.githubusercontent.com/SeanyBoii2/Universal-Scripts/refs/heads/main/Universal%20Npc%20Autofarm.txt",
	},
	{
		Name = "Infinite Yield",
		URL = "https://raw.githubusercontent.com/SeanyBoii2/Universal-Scripts/refs/heads/main/Infinite%20Yield.txt",
	},
	{
		Name = "Animation Logger",
		URL = "https://raw.githubusercontent.com/SeanyBoii2/Universal-Scripts/refs/heads/main/Animation%20Logger.txt",
	},
	{
		Name = "Server Saver",
		URL = "https://raw.githubusercontent.com/SeanyBoii2/Universal-Scripts/refs/heads/main/Server%20Saver",
	},
}

local ScriptsPage = Window:CreatePage("Scripts")
local ScriptSection = ScriptsPage:CreateSection("Script Loader")

ScriptSection:CreateLabel("Load universal scripts below")
ScriptSection:CreateDivider()

for _, scriptData in ipairs(SCRIPTS) do
    ScriptSection:CreateButton(scriptData.Name, function()
        if loadedScripts[scriptData.Name] then
            Window:Notify(scriptData.Name .. " already loaded!")
            return
        end

        Window:Notify("Loading " .. scriptData.Name .. "...")

        local success, err = pcall(function()
            loadstring(game:HttpGet(scriptData.URL))()
        end)

        if success then
            loadedScripts[scriptData.Name] = true
            Window:Notify(scriptData.Name .. " loaded!")
            sendNotification("Loaded", scriptData.Name .. " loaded successfully!")
        else
            Window:Notify("ERROR: " .. scriptData.Name .. " failed!")
            sendNotification("Error", "Failed to load " .. scriptData.Name)
            warn("Load error: " .. tostring(err))
        end
    end)
end


--╔══════════════════════════════════════════════════════════════════════════╗
--║                        MOVEMENT PAGE                                     ║
--╚══════════════════════════════════════════════════════════════════════════╝

local MovementPage = Window:CreatePage("Movement")

-- ═══════════════════ SPEED SECTION ═══════════════════
local SpeedSection = MovementPage:CreateSection("Speed")

SpeedSection:CreateLabel("Configure walk speed settings")
SpeedSection:CreateDivider()

local speedSlider = SpeedSection:CreateSlider("Walk Speed", {
    Min = 16,
    Max = 500,
    DefaultValue = 16,
    Step = 1
}, function(value)
    if speedEnabled and player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = value
    end
end)

SpeedSection:CreateToggle("Enable Speed", {
    Toggled = false
}, function(value)
    speedEnabled = value
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        if value then
            player.Character.Humanoid.WalkSpeed = speedSlider:Get()
        else
            player.Character.Humanoid.WalkSpeed = 16
        end
    end
end)

-- ═══════════════════ FLY SECTION ═══════════════════
local FlySection = MovementPage:CreateSection("Fly")

FlySection:CreateLabel("Use WASD + Space/Shift to fly")
FlySection:CreateDivider()

-- Fly functions
local function startFly()
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not hrp or not hum then return end

    local oldBV = hrp:FindFirstChild("SpookyFlyVel")
    local oldBG = hrp:FindFirstChild("SpookyFlyGyro")
    if oldBV then oldBV:Destroy() end
    if oldBG then oldBG:Destroy() end
    if flyBodyVel then pcall(function() flyBodyVel:Destroy() end) end
    if flyBodyGyro then pcall(function() flyBodyGyro:Destroy() end) end

    flyBodyGyro = Instance.new("BodyGyro")
    flyBodyGyro.Name = "SpookyFlyGyro"
    flyBodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    flyBodyGyro.P = 9e4
    flyBodyGyro.D = 600
    flyBodyGyro.CFrame = hrp.CFrame
    flyBodyGyro.Parent = hrp

    flyBodyVel = Instance.new("BodyVelocity")
    flyBodyVel.Name = "SpookyFlyVel"
    flyBodyVel.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    flyBodyVel.Velocity = Vector3.new(0, 0.1, 0)
    flyBodyVel.Parent = hrp

    hum:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
    hum:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
    hum:ChangeState(Enum.HumanoidStateType.Running)
end

local function stopFly()
    local char = player.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        if hum then
            hum:SetStateEnabled(Enum.HumanoidStateType.FallingDown, true)
            hum:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, true)
        end
    end
    if flyBodyVel then pcall(function() flyBodyVel:Destroy() end); flyBodyVel = nil end
    if flyBodyGyro then pcall(function() flyBodyGyro:Destroy() end); flyBodyGyro = nil end
end

-- Fly movement
local camera = workspace.CurrentCamera
local flyKeys = {
    [Enum.KeyCode.W] = true, [Enum.KeyCode.S] = true,
    [Enum.KeyCode.A] = true, [Enum.KeyCode.D] = true,
    [Enum.KeyCode.Space] = true, [Enum.KeyCode.LeftShift] = true,
}
local flyKeysDown = {}

UIS.InputBegan:Connect(function(input, _)
    if flyKeys[input.KeyCode] then
        flyKeysDown[input.KeyCode] = true
    end
end)

UIS.InputEnded:Connect(function(input, _)
    if flyKeys[input.KeyCode] then
        flyKeysDown[input.KeyCode] = false
    end
end)

RunService.Heartbeat:Connect(function()
    if not flyEnabled then return end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    if not flyBodyVel or not flyBodyVel.Parent then startFly(); return end
    if not flyBodyGyro or not flyBodyGyro.Parent then startFly(); return end

    camera = workspace.CurrentCamera
    local camCF = camera.CFrame
    local moveDir = Vector3.new(0, 0, 0)

    if flyKeysDown[Enum.KeyCode.W] then moveDir = moveDir + camCF.LookVector end
    if flyKeysDown[Enum.KeyCode.S] then moveDir = moveDir - camCF.LookVector end
    if flyKeysDown[Enum.KeyCode.A] then moveDir = moveDir - camCF.RightVector end
    if flyKeysDown[Enum.KeyCode.D] then moveDir = moveDir + camCF.RightVector end
    if flyKeysDown[Enum.KeyCode.Space] then moveDir = moveDir + Vector3.new(0, 1, 0) end
    if flyKeysDown[Enum.KeyCode.LeftShift] then moveDir = moveDir - Vector3.new(0, 1, 0) end

    if moveDir.Magnitude > 0 then
        moveDir = moveDir.Unit * flySpeed
    else
        moveDir = Vector3.new(0, 0.1, 0)
    end

    flyBodyVel.Velocity = moveDir
    flyBodyGyro.CFrame = camCF

    local hum = char:FindFirstChild("Humanoid")
    if hum and hum:GetState() == Enum.HumanoidStateType.FallingDown then
        hum:ChangeState(Enum.HumanoidStateType.Running)
    end
end)

player.CharacterAdded:Connect(function()
    flyBodyVel = nil
    flyBodyGyro = nil
    if flyEnabled then
        task.wait(1)
        startFly()
    end
end)

FlySection:CreateToggle("Enable Fly", {
    Toggled = false
}, function(value)
    flyEnabled = value
    if value then
        startFly()
    else
        stopFly()
    end
    Window:Notify("Fly: " .. (value and "ON" or "OFF"))
end)

FlySection:CreateSlider("Fly Speed", {
    Min = 20,
    Max = 400,
    DefaultValue = 80,
    Step = 5
}, function(value)
    flySpeed = value
end)

FlySection:CreateKeybind("Fly Toggle Key", {
    Default = Enum.KeyCode.G
}, function(key)
    flyEnabled = not flyEnabled
    if flyEnabled then
        startFly()
    else
        stopFly()
    end
    Window:Notify("Fly: " .. (flyEnabled and "ON" or "OFF"))
end)

-- ═══════════════════ JUMP SECTION ═══════════════════
local JumpSection = MovementPage:CreateSection("Jump")

JumpSection:CreateSlider("Jump Power", {
    Min = 50,
    Max = 500,
    DefaultValue = 50,
    Step = 5
}, function(value)
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.JumpPower = value
    end
end)

JumpSection:CreateToggle("Infinite Jump", {
    Toggled = false
}, function(value)
    infJumpEnabled = value
end)

UIS.JumpRequest:Connect(function()
    if infJumpEnabled and player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

-- ═══════════════════ NOCLIP SECTION ═══════════════════
local NoclipSection = MovementPage:CreateSection("Noclip")

NoclipSection:CreateToggle("Noclip", {
    Toggled = false
}, function(value)
    noclipEnabled = value
    Window:Notify("Noclip: " .. (value and "ON" or "OFF"))
end)

RunService.Stepped:Connect(function()
    if noclipEnabled and player.Character then
        for _, part in ipairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end
end)


--╔══════════════════════════════════════════════════════════════════════════╗
--║                           SERVER PAGE                                    ║
--╚══════════════════════════════════════════════════════════════════════════╝

local ServerPage = Window:CreatePage("Server")
local ServerSection = ServerPage:CreateSection("Server Tools")

ServerSection:CreateTextbox("Chat Message", "Type message...", function(text)
    if text and #text > 0 then
        Window:Notify("Message: " .. text)
    end
end)

ServerSection:CreateButton("Copy Server ID", function()
    if setclipboard then
        setclipboard(game.JobId)
        Window:Notify("Server ID copied!")
    else
        Window:Notify("Clipboard not supported")
    end
end)

ServerSection:CreateButton("Rejoin Server", function()
    Window:Notify("Rejoining...")
    
    local scriptUrl = "https://raw.githubusercontent.com/SeanyBoii2/Z/refs/heads/main/WHITELIST%20TRICKS"
    if syn and syn.queue_on_teleport then
        syn.queue_on_teleport('loadstring(game:HttpGet("' .. scriptUrl .. '"))()')
    elseif queue_on_teleport then
        queue_on_teleport('loadstring(game:HttpGet("' .. scriptUrl .. '"))()')
    end
    
    task.wait(0.5)
    pcall(function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId)
    end)
end)

ServerSection:CreateButton("Reset Character", function()
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.Health = 0
    end
    Window:Notify("Character reset!")
end)


--╔══════════════════════════════════════════════════════════════════════════╗
--║                           MISC PAGE                                      ║
--╚══════════════════════════════════════════════════════════════════════════╝

local MiscPage = Window:CreatePage("Misc")
local UtilSection = MiscPage:CreateSection("Utilities")

UtilSection:CreateToggle("Anti-AFK", {
    Toggled = true
}, function(value)
    Window:Notify("Anti-AFK: " .. (value and "ON" or "OFF"))
end)

-- Anti-AFK handler
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

UtilSection:CreateButton("Copy Discord", function()
    if setclipboard then
        setclipboard("spookyie")
        Window:Notify("Discord copied: spookyie")
    else
        Window:Notify("Discord: spookyie")
    end
end)

UtilSection:CreateTextbox("Webhook URL", "Paste webhook...", function(url)
    Window:Notify("Webhook saved!")
end)

UtilSection:CreateDivider()

local InfoSection = MiscPage:CreateSection("Information")

InfoSection:CreateLabel("Script: SPOOKY HUB V4")
InfoSection:CreateLabel("Discord: spookyie")
InfoSection:CreateDivider()

InfoSection:CreateButton("Credits", function()
    Window:Notify("Made by Spooky // Discord: spookyie")
end)

InfoSection:CreateButton("Destroy GUI", function()
    Window:Notify("Goodbye!")
    task.wait(1)
    Window:Destroy()
end)


--╔══════════════════════════════════════════════════════════════════════════╗
--║                     CONFIG PAGE                                          ║
--╚══════════════════════════════════════════════════════════════════════════╝

local ConfigPage = Window:CreatePage("Config")
local SaveLoadSection = ConfigPage:CreateSection("Profiles")

SaveLoadSection:CreateLabel("Save and load your settings")
SaveLoadSection:CreateDivider()

SaveLoadSection:CreateButton("Save Config", function()
    local profileName = "SpookyHub_" .. os.date("%H%M%S")
    Window:SaveConfig(profileName)
end)

SaveLoadSection:CreateButton("Load Config", function()
    local profiles = Window:GetProfiles()
    
    if #profiles == 0 then
        Window:Notify("No saved profiles")
        return
    end
    
    print("=== Available Profiles ===")
    for i, name in ipairs(profiles) do
        print(i .. ". " .. name)
    end
    
    Window:Notify("Check console for profiles")
    Window:LoadConfig(profiles[1])
end)

SaveLoadSection:CreateButton("List Profiles", function()
    local profiles = Window:GetProfiles()
    
    if #profiles == 0 then
        Window:Notify("No saved profiles")
    else
        print("=== Saved Profiles ===")
        for i, name in ipairs(profiles) do
            print(i .. ". " .. name)
        end
        Window:Notify(#profiles .. " profiles (check console)")
    end
end)

SaveLoadSection:CreateDivider()

SaveLoadSection:CreateButton("Export to Clipboard", function()
    Window:ExportConfig()
end)

local SettingsSection = ConfigPage:CreateSection("Settings")

SettingsSection:CreateToggle("Auto-Save", {
    Toggled = false
}, function(value)
    Window:SetAutoSave(value)
    Window:Notify("Auto-save: " .. (value and "ON" or "OFF"))
end)

SettingsSection:CreateLabel("Auto-save changes to current profile")


--╔══════════════════════════════════════════════════════════════════════════╗
--║                           INITIALIZATION                                 ║
--╚══════════════════════════════════════════════════════════════════════════╝

-- Load default profile
task.wait(1)
local profiles = Window:GetProfiles()
if table.find(profiles, "Default") then
    Window:LoadConfig("Default")
    print("[SPOOKY HUB] Loaded default profile")
else
    Window:SaveConfig("Default")
    print("[SPOOKY HUB] Created default profile")
end

-- Welcome notification
Window:Notify("Welcome to SPOOKY HUB!")

-- Console output
print("═══════════════════════════════════════════")
print("  SPOOKY HUB V4")
print("═══════════════════════════════════════════")
print("✓ Loaded successfully")
print("✓ Whitelist verified: " .. player.Name)
print("✓ Config system active")
print("✓ New elements active")
print("✓ All features ready")
print("───────────────────────────────────────────")
print("Press LEFT ALT to open menu")
print("Press F or SPACE to select")
print("Discord: spookyie")
print("───────────────────────────────────────────")
print("Pages:")
print("  - Scripts (6 loaders)")
print("  - Movement (Speed, Fly, Jump, Noclip)")
print("  - Server (Tools & rejoin)")
print("  - Misc (Utilities)")
print("  - Config (Save/Load system)")
print("═══════════════════════════════════════════")

print("Spooky Hub V4 loaded successfully!")
